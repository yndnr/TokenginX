# v0.1.0 MVP 开发任务清单

本文档详细列出 v0.1.0（MVP 最小可行产品）版本的所有开发任务，供开发人员参考和跟踪。

## 版本目标

**时间**：2025-12 ~ 2026-01（6 周 / 30 工作日）
**工时**：约 140 小时开发 + 38 小时测试 = 178 小时
**人员**：2 名开发 + 1 名测试

**核心目标**：
- ✅ 单机存储引擎
- ✅ TCP (RESP) 协议接口
- ✅ OAuth 2.0 基础支持
- ✅ 基础配置和监控
- ✅ 单元测试覆盖率 > 80%

## 1. 存储引擎（14 小时）

### 1.1 ShardedMap 实现（6h）

**Issue**: `[Storage] 实现 ShardedMap 基础结构`
**优先级**: P0
**预估**: 6h
**负责**: 开发 A

**任务清单**:
- [ ] 定义 `ShardedMap` 结构体
  ```go
  type ShardedMap struct {
      shards [256]*mapShard
      hash   hash.Hash64
  }

  type mapShard struct {
      mu    sync.RWMutex
      items map[string]*item
  }

  type item struct {
      value     interface{}
      expiresAt int64
  }
  ```
- [ ] 实现 `NewShardedMap(initialCapacity int)` 构造函数
- [ ] 实现 `getShard(key string) int` 哈希分片函数
- [ ] 实现 `Set(key string, value interface{}, ttl int) error` 方法
- [ ] 实现 `Get(key string) (interface{}, bool)` 方法
- [ ] 实现 `Delete(key string) bool` 方法
- [ ] 实现 `Exists(key string) bool` 方法
- [ ] 实现 `Len() int` 方法（统计所有分片）
- [ ] 添加单元测试（覆盖率 > 90%）
- [ ] 添加并发安全测试（`go test -race`）
- [ ] 添加性能基准测试（`BenchmarkShardedMap`）

**验收标准**:
- 所有单元测试通过
- 无数据竞争（`-race` 检测通过）
- 性能达标：单分片 GET > 1M ops/s

**依赖**: 无

---

### 1.2 TTL 管理（4h）

**Issue**: `[Storage] 实现 TTL 管理机制`
**优先级**: P0
**预估**: 4h
**负责**: 开发 A

**任务清单**:
- [ ] 实现惰性删除：在 `Get()` 时检查过期
  ```go
  func (s *mapShard) get(key string) (interface{}, bool) {
      s.mu.RLock()
      defer s.mu.RUnlock()

      item, exists := s.items[key]
      if !exists {
          return nil, false
      }

      // 检查是否过期
      if item.expiresAt > 0 && time.Now().Unix() > item.expiresAt {
          // 标记为过期（稍后清理）
          return nil, false
      }

      return item.value, true
  }
  ```
- [ ] 实现定期清理：后台 Goroutine 扫描过期键
- [ ] 实现 `startCleanup()` 启动清理任务
- [ ] 实现 `stopCleanup()` 停止清理任务
- [ ] 实现 `TTL(key string) int` 获取剩余 TTL
- [ ] 实现 `Expire(key string, ttl int) bool` 更新 TTL
- [ ] 添加清理策略配置（清理间隔、每次清理数量）
- [ ] 添加单元测试（测试过期删除）
- [ ] 添加压力测试（大量过期键）

**验收标准**:
- 惰性删除正常工作
- 定期清理不影响性能（CPU < 5%）
- 过期键能及时清理（延迟 < 1s）

**依赖**: 1.1 ShardedMap

---

### 1.3 基础 LRU 缓存（4h）

**Issue**: `[Storage] 实现基础 LRU 缓存`
**优先级**: P1
**预估**: 4h
**负责**: 开发 B

**任务清单**:
- [ ] 定义 `LRUCache` 结构体
  ```go
  type LRUCache struct {
      capacity int
      items    map[string]*list.Element
      evictList *list.List
      mu       sync.Mutex
  }

  type entry struct {
      key   string
      value interface{}
  }
  ```
- [ ] 实现 `NewLRUCache(capacity int)` 构造函数
- [ ] 实现 `Get(key string)` 方法（移到链表头）
- [ ] 实现 `Set(key, value)` 方法（淘汰最久未使用）
- [ ] 实现 `Remove(key string)` 方法
- [ ] 实现 `Len()` 和 `Cap()` 方法
- [ ] 集成到 `ShardedMap`（每个分片可选 LRU）
- [ ] 添加单元测试
- [ ] 添加缓存命中率测试

**验收标准**:
- LRU 淘汰策略正确
- 缓存命中率 > 90%（模拟测试）
- 性能开销 < 10%

**依赖**: 1.1 ShardedMap

---

## 2. TCP 传输层（20 小时）

### 2.1 RESP 协议解析器（6h）

**Issue**: `[Transport] 实现 RESP 协议解析器`
**优先级**: P0
**预估**: 6h
**负责**: 开发 A

**任务清单**:
- [ ] 定义 RESP 数据类型（Simple String, Error, Integer, Bulk String, Array）
  ```go
  type RESPType byte

  const (
      SimpleString RESPType = '+'
      Error        RESPType = '-'
      Integer      RESPType = ':'
      BulkString   RESPType = '$'
      Array        RESPType = '*'
  )

  type RESPValue struct {
      Type  RESPType
      Str   string
      Int   int64
      Bulk  []byte
      Array []RESPValue
  }
  ```
- [ ] 实现 `ParseRESP(reader *bufio.Reader)` 解析函数
- [ ] 实现 `WriteRESP(writer *bufio.Writer, value RESPValue)` 序列化函数
- [ ] 处理边界情况（大文件、空值、错误格式）
- [ ] 实现零拷贝优化（使用 `[]byte` 避免字符串转换）
- [ ] 添加解析测试（覆盖所有 RESP 类型）
- [ ] 添加性能基准测试

**验收标准**:
- 兼容 Redis RESP 协议
- 解析速度 > 100K ops/s
- 无内存泄漏

**依赖**: 无

---

### 2.2 TCP 服务器（6h）

**Issue**: `[Transport] 实现 TCP 服务器`
**优先级**: P0
**预估**: 6h
**负责**: 开发 A

**任务清单**:
- [ ] 实现 `TCPServer` 结构体
  ```go
  type TCPServer struct {
      addr     string
      listener net.Listener
      storage  *storage.ShardedMap
      handler  *CommandHandler
      conns    sync.Map // 连接管理
  }
  ```
- [ ] 实现 `Start()` 启动服务器
- [ ] 实现 `Stop()` 优雅关闭（等待现有连接完成）
- [ ] 实现 `handleConnection(conn net.Conn)` 处理单个连接
- [ ] 实现连接超时（读超时、写超时、空闲超时）
- [ ] 实现连接池管理（最大连接数限制）
- [ ] 实现连接统计（当前连接数、总连接数）
- [ ] 添加集成测试（使用 redis-cli 连接测试）
- [ ] 添加并发连接测试（1000+ 并发）

**验收标准**:
- 支持 10,000+ 并发连接
- 优雅关闭无连接丢失
- 连接超时正常工作

**依赖**: 2.1 RESP 解析器

---

### 2.3 命令处理器（4h）

**Issue**: `[Transport] 实现基础命令处理器`
**优先级**: P0
**预估**: 4h
**负责**: 开发 B

**任务清单**:
- [ ] 定义 `CommandHandler` 结构体
  ```go
  type CommandHandler struct {
      storage  *storage.ShardedMap
      commands map[string]CommandFunc
  }

  type CommandFunc func(args []RESPValue) RESPValue
  ```
- [ ] 实现 `RegisterCommand(name string, fn CommandFunc)` 注册命令
- [ ] 实现 `GET key` 命令
- [ ] 实现 `SET key value [EX seconds]` 命令
- [ ] 实现 `DEL key [key ...]` 命令
- [ ] 实现 `EXISTS key` 命令
- [ ] 实现 `TTL key` 命令
- [ ] 实现 `EXPIRE key seconds` 命令
- [ ] 实现 `PING` 命令
- [ ] 实现 `ECHO message` 命令
- [ ] 实现错误处理（参数错误、类型错误）
- [ ] 添加命令测试（每个命令独立测试）

**验收标准**:
- 所有命令符合 Redis 语义
- 错误信息清晰
- 参数验证完整

**依赖**: 1.1 ShardedMap, 2.1 RESP 解析器

---

### 2.4 连接管理（4h）

**Issue**: `[Transport] 实现连接管理和监控`
**优先级**: P1
**预估**: 4h
**负责**: 开发 B

**任务清单**:
- [ ] 实现 `CLIENT LIST` 命令（列出所有连接）
- [ ] 实现 `CLIENT KILL ip:port` 命令（关闭指定连接）
- [ ] 实现 `INFO` 命令（服务器统计信息）
  ```
  # Server
  redis_version:tokenginx-0.1.0
  uptime_in_seconds:3600

  # Clients
  connected_clients:42

  # Stats
  total_connections_received:1000
  total_commands_processed:50000
  ```
- [ ] 实现连接心跳检测
- [ ] 实现连接速率限制（每个 IP 最大连接数）
- [ ] 添加监控指标（连接数、命令数、错误数）

**验收标准**:
- CLIENT 命令正常工作
- INFO 输出格式正确
- 速率限制有效

**依赖**: 2.2 TCP 服务器

---

## 3. OAuth 2.0 支持（10 小时）

### 3.1 Token 存储（4h）

**Issue**: `[Protocol] 实现 OAuth 2.0 Token 存储`
**优先级**: P0
**预估**: 4h
**负责**: 开发 A

**任务清单**:
- [ ] 定义 Token 数据结构
  ```go
  type OAuthToken struct {
      AccessToken  string
      RefreshToken string
      TokenType    string
      ExpiresIn    int
      Scope        string
      UserID       string
      ClientID     string
      CreatedAt    time.Time
  }
  ```
- [ ] 实现 `StoreAccessToken(token *OAuthToken, ttl int)` 存储访问令牌
- [ ] 实现 `GetAccessToken(accessToken string)` 获取访问令牌
- [ ] 实现 `DeleteAccessToken(accessToken string)` 删除访问令牌
- [ ] 实现 `StoreRefreshToken(token *OAuthToken, ttl int)` 存储刷新令牌
- [ ] 实现 `GetRefreshToken(refreshToken string)` 获取刷新令牌
- [ ] 实现 Token 自动过期（基于 TTL）
- [ ] 添加 Token 序列化/反序列化（JSON）
- [ ] 添加单元测试

**验收标准**:
- Token 存储和检索正确
- TTL 自动过期生效
- 支持 JSON 序列化

**依赖**: 1.1 ShardedMap

---

### 3.2 Authorization Code（3h）

**Issue**: `[Protocol] 实现 OAuth 2.0 Authorization Code 流程`
**优先级**: P0
**预估**: 3h
**负责**: 开发 B

**任务清单**:
- [ ] 定义 AuthCode 数据结构
  ```go
  type AuthorizationCode struct {
      Code        string
      ClientID    string
      RedirectURI string
      Scope       string
      UserID      string
      ExpiresAt   time.Time
  }
  ```
- [ ] 实现 `StoreAuthCode(code *AuthorizationCode, ttl int)` 存储授权码
- [ ] 实现 `GetAuthCode(code string)` 获取授权码
- [ ] 实现 `DeleteAuthCode(code string)` 删除授权码（一次性使用）
- [ ] 实现授权码过期（默认 10 分钟）
- [ ] 实现防重放检测（授权码只能使用一次）
- [ ] 添加单元测试

**验收标准**:
- 授权码只能使用一次
- 过期授权码无法使用
- 防重放检测有效

**依赖**: 1.1 ShardedMap

---

### 3.3 Token Introspection（3h）

**Issue**: `[Protocol] 实现 Token Introspection (RFC 7662)`
**优先级**: P1
**预估**: 3h
**负责**: 开发 A

**任务清单**:
- [ ] 实现 `IntrospectToken(token string)` 检查令牌有效性
  ```go
  type IntrospectionResponse struct {
      Active    bool   `json:"active"`
      Scope     string `json:"scope,omitempty"`
      ClientID  string `json:"client_id,omitempty"`
      Username  string `json:"username,omitempty"`
      TokenType string `json:"token_type,omitempty"`
      Exp       int64  `json:"exp,omitempty"`
      Iat       int64  `json:"iat,omitempty"`
  }
  ```
- [ ] 实现 Token 有效性检查（是否存在、是否过期）
- [ ] 实现 Token 元数据返回
- [ ] 添加 HTTP/REST API 接口（POST /oauth/introspect）
- [ ] 添加集成测试

**验收标准**:
- Introspection 响应符合 RFC 7662
- 有效性检查准确
- API 接口正常工作

**依赖**: 3.1 Token 存储

---

## 4. 配置系统（6 小时）

### 4.1 配置文件解析（3h）

**Issue**: `[Config] 实现配置文件解析`
**优先级**: P0
**预估**: 3h
**负责**: 开发 B

**任务清单**:
- [ ] 定义配置结构体（参考 `config.example.yaml`）
  ```go
  type Config struct {
      Server  ServerConfig  `yaml:"server"`
      Storage StorageConfig `yaml:"storage"`
      Cache   CacheConfig   `yaml:"cache"`
      OAuth   OAuthConfig   `yaml:"oauth"`
  }
  ```
- [ ] 实现 `LoadConfig(path string)` 加载 YAML 配置
- [ ] 实现配置验证（必填项检查、范围检查）
- [ ] 实现默认配置（无配置文件时使用默认值）
- [ ] 添加配置测试

**验收标准**:
- YAML 解析正确
- 配置验证有效
- 默认配置可用

**依赖**: 无

---

### 4.2 环境变量支持（2h）

**Issue**: `[Config] 支持环境变量配置`
**优先级**: P1
**预估**: 2h
**负责**: 开发 B

**任务清单**:
- [ ] 实现环境变量覆盖配置文件
  ```
  TOKENGINX_SERVER_TCP_ADDR=0.0.0.0:6380
  TOKENGINX_STORAGE_SHARD_COUNT=256
  ```
- [ ] 实现 `LoadFromEnv()` 从环境变量加载
- [ ] 实现优先级：环境变量 > 配置文件 > 默认值
- [ ] 添加环境变量文档
- [ ] 添加测试

**验收标准**:
- 环境变量正常工作
- 优先级正确
- 文档完整

**依赖**: 4.1 配置文件解析

---

### 4.3 配置热更新（可选，1h）

**Issue**: `[Config] 支持配置热更新`
**优先级**: P2
**预估**: 1h
**负责**: 开发 A

**任务清单**:
- [ ] 实现配置文件监控（使用 fsnotify）
- [ ] 实现配置重载（仅支持部分配置项）
- [ ] 实现配置变更通知
- [ ] 添加测试

**验收标准**:
- 配置文件修改后自动重载
- 不影响现有连接
- 日志记录配置变更

**依赖**: 4.1 配置文件解析

---

## 5. CLI 工具（10 小时）

### 5.1 tokenginx-server（6h）

**Issue**: `[CLI] 实现 tokenginx-server 主程序`
**优先级**: P0
**预估**: 6h
**负责**: 开发 A

**任务清单**:
- [ ] 实现 `main()` 函数（`cmd/server/main.go`）
- [ ] 实现命令行参数解析
  ```bash
  tokenginx-server -config config.yaml -addr :6380
  ```
- [ ] 实现版本信息（`-version`）
- [ ] 实现帮助信息（`-help`）
- [ ] 实现优雅启动和关闭
- [ ] 实现信号处理（SIGINT, SIGTERM）
- [ ] 实现日志初始化
- [ ] 添加启动测试

**验收标准**:
- 命令行参数正常工作
- 优雅关闭无数据丢失
- 日志输出正确

**依赖**: 所有核心模块

---

### 5.2 tokenginx-client（4h）

**Issue**: `[CLI] 实现 tokenginx-client 客户端工具`
**优先级**: P1
**预估**: 4h
**负责**: 开发 B

**任务清单**:
- [ ] 实现 `main()` 函数（`cmd/client/main.go`）
- [ ] 实现连接服务器（`-server localhost:6380`）
- [ ] 实现交互式 REPL
  ```bash
  tokenginx> SET key value
  OK
  tokenginx> GET key
  "value"
  ```
- [ ] 实现单命令执行（`tokenginx-client -c "GET key"`）
- [ ] 实现批量执行（从文件读取命令）
- [ ] 实现输出格式化
- [ ] 添加使用文档

**验收标准**:
- 可连接服务器
- REPL 正常工作
- 命令执行正确

**依赖**: 2.1 RESP 协议

---

## 6. 监控和日志（4 小时）

### 6.1 日志系统（2h）

**Issue**: `[Monitoring] 实现结构化日志`
**优先级**: P0
**预估**: 2h
**负责**: 开发 A

**任务清单**:
- [ ] 集成日志库（推荐 `zap` 或 `logrus`）
- [ ] 实现日志级别（DEBUG, INFO, WARN, ERROR）
- [ ] 实现日志格式（JSON 或 Text）
- [ ] 实现日志输出（stdout 或文件）
- [ ] 实现日志轮转（按大小或时间）
- [ ] 添加关键操作日志（启动、关闭、错误）

**验收标准**:
- 日志输出正常
- JSON 格式正确
- 轮转策略有效

**依赖**: 无

---

### 6.2 性能指标（2h）

**Issue**: `[Monitoring] 实现基础性能指标`
**优先级**: P1
**预估**: 2h
**负责**: 开发 B

**任务清单**:
- [ ] 实现 `Stats` 结构体（统计指标）
  ```go
  type Stats struct {
      TotalConnections    int64
      CurrentConnections  int64
      TotalCommands       int64
      TotalErrors         int64
      UptimeSeconds       int64
  }
  ```
- [ ] 实现 `INFO stats` 命令（输出统计信息）
- [ ] 实现 QPS 计算（每秒命令数）
- [ ] 实现延迟统计（P50, P99）
- [ ] 实现内存使用统计

**验收标准**:
- 统计指标准确
- INFO 命令输出正确
- 性能开销 < 1%

**依赖**: 2.3 命令处理器

---

## 7. 文档（6 小时）

### 7.1 API 文档（2h）

**Issue**: `[Docs] 完善 API 参考文档`
**优先级**: P1
**预估**: 2h
**负责**: 技术写作

**任务清单**:
- [ ] 完善 `docs/reference/tcp-resp-api.md`（所有命令）
- [ ] 添加命令示例
- [ ] 添加错误码说明
- [ ] 添加性能建议

**验收标准**:
- 文档覆盖所有命令
- 示例可执行
- 格式统一

**依赖**: 2.3 命令处理器

---

### 7.2 快速开始指南（2h）

**Issue**: `[Docs] 更新快速开始指南`
**优先级**: P1
**预估**: 2h
**负责**: 技术写作

**任务清单**:
- [ ] 更新 `readme.md`（v0.1.0 功能）
- [ ] 更新安装说明
- [ ] 更新快速示例
- [ ] 添加故障排查

**验收标准**:
- 新手可按文档快速上手
- 示例可正常运行

**依赖**: 所有模块

---

### 7.3 GoDoc 注释（2h）

**Issue**: `[Docs] 完善 GoDoc 代码注释`
**优先级**: P1
**预估**: 2h
**负责**: 开发 A + B

**任务清单**:
- [ ] 为所有导出函数添加 GoDoc 注释
- [ ] 为所有导出类型添加注释
- [ ] 为所有包添加包级注释
- [ ] 添加使用示例（Example 测试）

**验收标准**:
- GoDoc 注释覆盖率 100%
- 示例代码可运行

**依赖**: 所有模块

---

## 总结

### 任务统计

| 模块 | 任务数 | 工时 | 优先级分布 |
|-----|-------|------|-----------|
| 存储引擎 | 3 | 14h | P0: 2, P1: 1 |
| TCP 传输层 | 4 | 20h | P0: 3, P1: 1 |
| OAuth 2.0 | 3 | 10h | P0: 2, P1: 1 |
| 配置系统 | 3 | 6h | P0: 1, P1: 1, P2: 1 |
| CLI 工具 | 2 | 10h | P0: 1, P1: 1 |
| 监控日志 | 2 | 4h | P0: 1, P1: 1 |
| 文档 | 3 | 6h | P1: 3 |
| **总计** | **20** | **70h** | P0: 10, P1: 9, P2: 1 |

**注**：以上为开发工时，测试工时另计（见测试任务清单）。

### 关键路径

```
ShardedMap (6h)
    ↓
TTL 管理 (4h)
    ↓
RESP 解析器 (6h)
    ↓
TCP 服务器 (6h)
    ↓
命令处理器 (4h)
    ↓
Token 存储 (4h)
    ↓
配置系统 (3h)
    ↓
tokenginx-server (6h)
    ↓
集成测试 (8h)
────────────────
总计：47h（关键路径）
```

### 并行开发建议

**第 1 周**（开发 A + 开发 B）：
- A: ShardedMap (6h) + TTL (4h) = 10h
- B: 配置系统 (6h) + LRU 缓存 (4h) = 10h

**第 2 周**：
- A: RESP 解析器 (6h) + TCP 服务器 (6h) = 12h
- B: 命令处理器 (4h) + 连接管理 (4h) = 8h

**第 3 周**：
- A: Token 存储 (4h) + Introspection (3h) + 日志 (2h) = 9h
- B: AuthCode (3h) + tokenginx-client (4h) + 指标 (2h) = 9h

**第 4 周**：
- A + B: tokenginx-server (6h) + 文档 (6h) = 12h

**第 5-6 周**：测试和修复（见测试任务清单）

### 风险提示

1. **ShardedMap 性能**：需要仔细调优锁粒度
2. **RESP 解析**：边界情况处理复杂
3. **并发测试**：需要充分的并发压力测试
4. **文档完整性**：确保所有功能有文档

### 下一步

- 创建 GitHub Issues（使用 `scripts/create-v0.1.0-issues.sh`）
- 分配任务给团队成员
- 开始第 1 周开发
- 每日站会跟踪进度
