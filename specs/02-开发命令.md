# 开发命令

## 构建

```bash
# 构建所有二进制文件
go build -o bin/tokenginx-server ./cmd/server
go build -o bin/tokenginx-client ./cmd/client

# 构建并指定版本信息
go build -ldflags "-X main.version=v0.1.0" -o bin/tokenginx-server ./cmd/server

# 交叉编译（示例：Linux AMD64）
GOOS=linux GOARCH=amd64 go build -o bin/tokenginx-server-linux-amd64 ./cmd/server

# 构建所有平台
make build-all  # 如果有 Makefile
```

## 测试

```bash
# 运行所有测试
go test ./...

# 运行带覆盖率的测试
go test -cover ./...

# 运行详细测试输出
go test -v ./...

# 运行单个包的测试
go test ./internal/storage/...

# 运行性能基准测试
go test -bench=. -benchmem ./...

# 运行特定的基准测试
go test -bench=BenchmarkShardedMap -benchmem ./internal/storage/
```

## 代码质量

```bash
# 格式化代码
go fmt ./...

# 代码检查
go vet ./...

# 使用 golangci-lint（如果配置）
golangci-lint run

# 依赖管理
go mod tidy
go mod download
go mod verify
```

## 运行

```bash
# 运行服务器（默认配置）
./bin/tokenginx-server

# 使用配置文件运行
./bin/tokenginx-server -config ./config.yaml

# 运行客户端
./bin/tokenginx-client -server localhost:6380
```

## Git 工作流

### 分支策略

```bash
# 主要分支
main        # 稳定版本，用于生产发布
develop     # 开发分支，日常开发的主分支

# 功能分支命名
feature/oauth-support           # 新功能
bugfix/session-expiry-issue     # Bug 修复
hotfix/security-patch           # 紧急修复
release/v0.1.0                  # 发布准备
```

### 提交信息规范（遵循 Conventional Commits）

```bash
# 格式：<type>(<scope>): <subject>

# 类型（type）
feat:      # 新功能
fix:       # Bug 修复
docs:      # 文档更新
style:     # 代码格式（不影响功能）
refactor:  # 重构（既不是新功能也不是修复）
perf:      # 性能优化
test:      # 测试相关
chore:     # 构建过程或辅助工具的变动
ci:        # CI/CD 配置文件和脚本的变动

# 示例
git commit -m "feat(oauth): add authorization code flow support"
git commit -m "fix(storage): resolve race condition in shard locking"
git commit -m "perf(cache): optimize w-tinylfu eviction algorithm"
git commit -m "docs(readme): update installation instructions"
git commit -m "test(transport): add grpc integration tests"
```

### 常用 Git 命令

```bash
# 创建功能分支
git checkout -b feature/new-feature develop

# 提交代码前检查
go fmt ./...                    # 格式化代码
go vet ./...                    # 静态分析
go test ./...                   # 运行测试
golangci-lint run              # 代码检查（如果配置）

# 提交代码
git add .
git commit -m "feat(module): description"

# 推送到远程
git push origin feature/new-feature

# 更新本地分支
git checkout develop
git pull origin develop

# 合并功能分支（使用 Pull Request 在 GitHub 上操作）
# 不要直接在本地合并到 main/develop
```

### Pull Request 规范

- PR 标题遵循 Conventional Commits 格式
- 提供清晰的描述和变更说明
- 关联相关的 Issue（使用 `Closes #123` 或 `Fixes #456`）
- 确保 CI 检查通过
- 至少一个代码审查批准后才能合并

## CI/CD（GitHub Actions）

### 自动化工作流

```yaml
# .github/workflows/ci.yml 应包含：
- 代码格式检查（go fmt）
- 静态分析（go vet, golangci-lint）
- 单元测试和覆盖率
- 数据竞争检测（go test -race）
- 性能基准测试
- 多平台构建测试（Linux, macOS, Windows）
- 多架构构建（amd64, arm64）
```

### 发布流程

```bash
# 1. 创建发布分支
git checkout -b release/v0.1.0 develop

# 2. 更新版本号和 changelog
# 编辑 version.go 或 Makefile 中的版本号
# 更新 changelog.md

# 3. 提交版本更新
git commit -am "chore(release): bump version to v0.1.0"

# 4. 合并到 main 并打标签
git checkout main
git merge --no-ff release/v0.1.0
git tag -a v0.1.0 -m "Release version 0.1.0"
git push origin main --tags

# 5. 合并回 develop
git checkout develop
git merge --no-ff release/v0.1.0
git push origin develop

# GitHub Actions 将自动：
# - 运行完整的测试套件
# - 构建多平台二进制文件
# - 创建 GitHub Release
# - 上传构建产物
```
