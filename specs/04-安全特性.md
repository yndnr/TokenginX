# 安全特性

TokenGinX 采用纵深防御策略，提供企业级安全保障，支持国密和国际商密双体系。

## 传输层安全

### TLS 加密通信

- **TLS 1.3**：默认使用 TLS 1.3，禁用不安全的旧版本（TLS 1.0/1.1）
- **密码套件**：
  - 国密套件：`ECDHE_SM4_GCM_SM3`、`ECC_SM4_GCM_SM3`
  - 商密套件：`TLS_AES_256_GCM_SHA384`、`TLS_CHACHA20_POLY1305_SHA256`
- **双体系支持**：同时支持国密和商密，客户端协商选择
- **证书管理**：
  - 支持 X.509（RSA/ECDSA）和 SM2 证书
  - 支持自签名证书和 CA 签发证书
  - 支持证书链验证和 CRL/OCSP 吊销检查
  - 支持证书热更新（无需重启服务）

### mTLS 双向认证

- **客户端认证**：服务器验证客户端证书
- **服务器认证**：客户端验证服务器证书
- **证书绑定**：将客户端证书与访问权限绑定
- **国密 mTLS**：支持 SM2 证书的双向认证
- **商密 mTLS**：支持 RSA/ECDSA 证书的双向认证

## 认证与授权

### 客户端认证机制

- **证书认证**（推荐）：基于 mTLS 的客户端证书认证
- **令牌认证**：使用 JWT 或自定义令牌
- **用户名/密码**：支持 PBKDF2/bcrypt 哈希存储
- **API Key**：支持静态 API Key 认证（适用于机器间通信）
- **多因素认证**：支持证书 + 令牌组合认证

### 访问控制列表（ACL）

- **基于角色的访问控制（RBAC）**：
  - 预定义角色：admin、operator、readonly
  - 自定义角色支持
- **命令级权限**：控制客户端可执行的命令（GET、SET、DELETE 等）
- **键级权限**：基于键前缀的细粒度访问控制
  ```
  role:oauth_admin -> 允许访问 "oauth:*" 键
  role:saml_readonly -> 只读访问 "saml:*" 键
  ```
- **IP 白名单/黑名单**：限制客户端来源 IP
- **时间窗口控制**：限制访问时间段

### 会话管理

- **会话令牌**：客户端连接后颁发会话令牌
- **会话超时**：空闲超时和绝对超时
- **并发连接限制**：单个用户/IP 的最大连接数
- **会话绑定**：会话与 IP/证书绑定，防止会话劫持

## 防重放攻击

### 基于时间戳的防重放

- **请求时间戳**：每个请求包含时间戳
- **时间窗口验证**：拒绝超出时间窗口的请求（默认 5 分钟）
- **时钟偏移容忍**：允许合理的时钟偏移（±30 秒）

### 基于 Nonce 的防重放

- **一次性随机数（Nonce）**：每个请求携带唯一 Nonce
- **Nonce 缓存**：服务器缓存最近使用的 Nonce（滑动窗口）
- **Nonce 验证**：拒绝重复的 Nonce
- **过期清理**：自动清理过期的 Nonce 记录

### 请求签名

- **HMAC 签名**：使用共享密钥对请求进行 HMAC-SHA256/SM3 签名
- **签名内容**：包含请求方法、URI、时间戳、Nonce、请求体
- **签名验证**：服务器验证签名完整性
- **示例流程**：
  ```
  1. 客户端生成 Nonce 和时间戳
  2. 构造签名字符串：method + uri + timestamp + nonce + body
  3. 使用密钥计算 HMAC：signature = HMAC(key, signString)
  4. 发送请求：headers 包含 timestamp, nonce, signature
  5. 服务器验证时间窗口、Nonce 唯一性、签名正确性
  ```

### 序列号机制（可选）

- **单调递增序列号**：每个请求携带递增的序列号
- **序列号验证**：拒绝序列号回退的请求
- **适用场景**：有序的请求场景

## 数据加密

### 内存数据加密

- **AES-256-GCM**：敏感数据（如会话令牌、密码）在内存中加密存储
- **SM4-GCM**：国密场景下使用 SM4 对称加密
- **密钥管理**：
  - 主密钥（Master Key）用于加密数据加密密钥（DEK）
  - 支持密钥轮换（Key Rotation）
  - 支持密钥派生函数（KDF）

### 持久化数据加密

- **透明加密**：mmap 文件和 WAL 日志自动加密
- **加密算法**：AES-256-GCM（商密）或 SM4-GCM（国密）
- **加密粒度**：块级加密，支持随机访问
- **密钥存储**：
  - 环境变量
  - 密钥管理服务（KMS）集成
  - HSM（硬件安全模块）支持（企业版）

### 字段级加密（可选）

- **选择性加密**：对特定字段（如用户密码、敏感属性）单独加密
- **加密上下文**：支持额外的认证数据（AAD）

## 安全审计

### 审计日志

- **JSON 格式**：结构化日志，便于解析和分析
- **记录内容**：
  - 时间戳（精确到毫秒）
  - 客户端信息（IP、用户、证书指纹）
  - 操作类型（GET、SET、DELETE、AUTH 等）
  - 目标资源（键名）
  - 操作结果（成功/失败）
  - 错误信息（如果失败）
- **敏感信息脱敏**：密码、令牌等敏感数据不记录或脱敏
- **日志加密**：审计日志可选加密存储
- **日志轮转**：按大小或时间轮转日志文件
- **Syslog 集成**：支持发送到远程 Syslog 服务器

### 审计事件类型

- **认证事件**：登录、登出、认证失败
- **授权事件**：权限检查、访问拒绝
- **数据访问**：GET、SET、DELETE 操作
- **配置变更**：ACL 修改、用户添加/删除
- **安全事件**：重放攻击检测、暴力破解尝试、异常访问

### 示例审计日志

```json
{
  "timestamp": "2025-11-19T12:34:56.789Z",
  "event_type": "data_access",
  "client_ip": "192.168.1.100",
  "user": "oauth_admin",
  "cert_fingerprint": "SHA256:ab:cd:ef...",
  "command": "SET",
  "key": "oauth:token:abc123",
  "result": "success",
  "latency_ms": 0.85
}
```

## 速率限制与防护

### 速率限制（Rate Limiting）

- **限流维度**：
  - 全局限流：整个服务器的总 QPS
  - 用户限流：单个用户的 QPS
  - IP 限流：单个 IP 的 QPS
  - 命令限流：特定命令的 QPS
- **限流算法**：
  - 令牌桶（Token Bucket）
  - 滑动窗口（Sliding Window）
- **限流响应**：
  - 返回 429 Too Many Requests（HTTP）
  - 返回错误码（RESP/gRPC）
  - 延迟响应（可选）

### 暴力破解防护

- **登录失败检测**：记录连续认证失败次数
- **临时封禁**：超过阈值后临时封禁（默认 5 次失败封禁 15 分钟）
- **渐进式延迟**：失败次数越多，响应延迟越长
- **验证码集成**：支持在 HTTP 接口中集成 CAPTCHA

### DDoS 防护

- **连接限制**：最大并发连接数
- **慢速攻击防护**：超时断开慢速连接
- **资源配额**：限制单个连接的内存/CPU 使用

### 输入验证

- **键名验证**：限制键名长度、字符集
- **值大小限制**：限制单个值的最大大小
- **命令参数验证**：验证命令参数的合法性
- **防注入**：防止命令注入、路径遍历等攻击

## 国密与商密双体系

### 国密算法支持（GM/T 标准）

- **SM2**：公钥加密和数字签名（替代 RSA/ECDSA）
- **SM3**：哈希算法（替代 SHA-256）
- **SM4**：对称加密（替代 AES）
- **SM9**：标识密码算法（可选，用于身份认证）

### TLS 国密支持（TLCP/GM 双证书）

- **签名证书**：SM2 签名证书用于身份认证
- **加密证书**：SM2 加密证书用于密钥交换
- **双证书模式**：同时使用签名证书和加密证书（符合国密 TLS 规范）
- **国密 TLS 1.3**：支持 TLCP 1.1 和国密 TLS 1.3

### 商密算法支持（国际标准）

- **RSA**：2048/4096 位（密钥交换、签名）
- **ECDSA**：P-256/P-384（签名）
- **SHA-256/SHA-384**：哈希算法
- **AES-256-GCM**：对称加密
- **ChaCha20-Poly1305**：对称加密（移动端优化）

### 双体系切换

- **配置化切换**：通过配置文件选择国密或商密
- **协商模式**：客户端和服务器协商使用国密或商密
- **混合模式**：同时支持国密和商密客户端连接

### 国密库依赖

- 推荐使用 `github.com/tjfoc/gmsm`（国密算法 Go 实现）
- 支持硬件国密卡（企业版）

### 配置示例

```yaml
security:
  crypto_mode: "auto"  # auto | gm | sm | hybrid

  # TLS 配置
  tls:
    enabled: true
    version: "1.3"
    cert_file: "/path/to/cert.pem"       # 商密证书
    key_file: "/path/to/key.pem"         # 商密私钥
    gm_sign_cert: "/path/to/sm2_sign.pem"    # 国密签名证书
    gm_sign_key: "/path/to/sm2_sign_key.pem" # 国密签名私钥
    gm_enc_cert: "/path/to/sm2_enc.pem"      # 国密加密证书
    gm_enc_key: "/path/to/sm2_enc_key.pem"   # 国密加密私钥
    client_auth: "require"  # none | request | require
    ca_file: "/path/to/ca.pem"

  # 数据加密
  encryption:
    enabled: true
    algorithm: "auto"  # auto | aes-256-gcm | sm4-gcm
    master_key_source: "env"  # env | kms | file
    key_rotation_days: 90

  # 防重放
  anti_replay:
    enabled: true
    window_seconds: 300
    nonce_cache_size: 100000

  # ACL
  acl:
    enabled: true
    default_deny: true

  # 审计
  audit:
    enabled: true
    format: "json"
    output: "/var/log/tokenginx/audit.log"
    encrypt_log: true

  # 速率限制
  rate_limit:
    global_qps: 100000
    per_user_qps: 10000
    per_ip_qps: 5000
```

## 安全开发实践

### 密钥管理

- **不硬编码密钥**：禁止在代码中硬编码密钥、密码
- **环境变量注入**：通过环境变量或配置文件注入密钥
- **密钥轮换**：定期轮换加密密钥
- **密钥销毁**：使用后立即清零内存中的密钥

### 安全编码

- **避免时序攻击**：密码比较使用 `subtle.ConstantTimeCompare`
- **防止缓冲区溢出**：使用 Go 的内存安全特性
- **避免 SQL 注入**：使用参数化查询（如果使用数据库）
- **输入验证**：验证所有外部输入

### 依赖安全

- **定期更新依赖**：使用 `go mod tidy` 和 `go get -u`
- **漏洞扫描**：使用 `govulncheck` 扫描已知漏洞
- **最小依赖原则**：仅引入必要的依赖

### 安全测试

- **渗透测试**：定期进行安全渗透测试
- **模糊测试**：使用 Go fuzzing 进行模糊测试
- **静态分析**：使用 `gosec` 进行安全静态分析
